***

# Vorbereitung des Domain Controllers / KDC

## IP, Gateway und DNS  anpassen:
[VM preparation](VM%20preparation.md)

## Samba DC auf `VMLS1` installieren
### Netzwerk konfigurieren:

#### Netplan

Das file `/etc/netplan/00-eth0.yaml` wurde bereits in [VM preparation](VM%20preparation.md) angepasst. 
Es muss lediglich noch angewendet werden:

```bash
sudo netplan apply --debug
```

#### anpassen von `/etc/hosts`

**Inhalt:**
`cat /etc/hosts`

```hosts
127.0.0.1	localhost.localdomain	localhost
127.0.1.1	vmLS1.sam159.iet-gibb.ch	vmLS1
192.168.110.61	vmLS1.sam159.iet-gibb.ch	vmLS1

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```
#### anpassen von `/etc/hostname`

`cat /etc/hostname`
```hostname
vmLS1.sam159.iet-gibb.ch
```

## Packages installieren

### VM updaten:

```root
apt update
apt -y upgrade
```

### Packages installieren:

```root
apt install samba smbclient heimdal-clients
```

```root
apt install acl attr build-essential libacl1-dev libattr1-dev libblkid-dev libgnutls28-dev libreadline-dev python2-dev python2 python-dev-is-python3 python3-dnspython gdb pkg-config libpopt-dev libldap2-dev libbsd-dev attr krb5-user docbook-xsl libcups2-dev acl ntp ntpdate net-tools git winbind libpam0g-dev dnsutils lsof
```
>[!question] Default Kerberos version 5 realm:
>Eingabe: `SAM159.IET-GIBB.CH`

>[!question] Kerberos servers for your realm (both):
>Eingabe: `vmLS1.sam159.iet-gibb.ch`

### smb.conf sichern:

`mv /etc/samba/smb.conf /etc/samba/smb.conf.orig`

## Samba als KDC setup:

```root
samba-tool domain provision
```

**Realm:** `SAM159.IET-GIBB.CH`
**Domain:** `SAM159`
**Server Role:** `dc`
**DNS backend:** `SAMBA_INTERNAL`
**DNS forwarder IP:** `8.8.8.8`
**Administrator password:** `SmL12345**`

**Check:**
	![](Pasted%20image%2020230918170225.png)
	![](Pasted%20image%2020230918170237.png)
### DNS resolver deaktivieren:

```root
systemctl disable systemd-resolved
systemctl stop systemd-resolved
rm /etc/resolv.conf
```

### Neues `resolv.conf` erstellen

`editor /etc/resolv.conf`

```resolv.conf
nameserver 192.168.110.61
search sam159.iet-gibb.ch
```

### Inhalt von `/etc/samba/smb.conf` kontrollieren

```smb.conf
# Global parameters
[global]
	dns forwarder = 8.8.8.8
	netbios name = VMLS1
	realm = SAM159.IET-GIBB.CH
	server role = active directory domain controller
	workgroup = SAM159

[sysvol]
	path = /var/lib/samba/sysvol
	read only = No

[netlogon]
	path = /var/lib/samba/sysvol/sam159.iet-gibb.ch/scripts
	read only = No
```

### Autostart von samba:

```root
systemctl unmask samba-ad-dc
systemctl enable samba-ad-dc
systemctl start samba-ad-dc
```

```root
reboot
```

```root
systemctl status samba-ad-dc
```

**Output (sollte running sein):**
![](Pasted%20image%2020230918171121.png)
### samba zur verwendung von Kerberos-authentifizhierungsdiensts konfigurieren.

#### Alte conf löschen:
`rm /etc/krb5.conf`

#### Neue datei erstellen:

`editor /etc/krb5.conf`
**inhalt:**
```krb5.conf
[libdefaults]
    default_realm = SAM159.IET-GIBB.CH
    fcc-mit-ticketflags = true

[realms]
    SAM159.IET-GIBB.CH = {
        kdc = vmLS1.sam159.iet-gibb.ch
        admin_server = vmLS1.sam159.iet-gibb.ch
    }

[domain_realm]
    .sam159.iet-gibb.ch = SAM159.IET-GIBB.CH
    sam159.iet-gibb.ch = SAM159.IET-GIBB.CH
```
>[!info]
>Der `[domain_realm]` `.sam159.iet-gibb.ch` bedeutet das alle subdomains beachtet werden.

## Netzwerk testen:

### Aktuelle DNS Server anzeigen

```bash
systemctl enable systemd-resolved
systemctl start systemd-resolved
systemctl status systemd-resolved
resolvectl status
```

>[!tip] Output von `resolvectl status` sollte sich selbst als dns server anzeigen:
>![](Pasted%20image%2020230918172117.png)

### Resolver service ausschalten:

**Jetzt kann der Resolver-service wieder ausgeschaltet werden und der LS1 kann auch neugestartet werden:**

```bash
systemctl stop systemd-resolved
systemctl disable systemd-resolved
reboot
```

### Überprüfen ob Ports `listening` sind:

```root
netstat -tlpn
```

![](Pasted%20image%2020230918172520.png)

>[!warning] Local  address sollte immer 0.0.0.0 lauten.

### Interner DNS-Service aktualisieren:

```root
samba_dnsupdate --verbose
```

>[!warning] keine fehler dürfen angezeigt werden...

### DNS testen auf wichtige eingräge:

```bash
host -t SRV_kerberos._tcp.sam159.iet-gibb.ch
```
*ouput:*
![](Pasted%20image%2020230918173044.png)

**ab P7**